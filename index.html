<!DOCTYPE html>
<html>
<head>
  <title>Harpy YouTube Downloader</title>
</head>
<body>
  <h2>ğŸ¥ YouTube Downloader</h2>

  <input id="url" placeholder="Paste YouTube link" size="50">
  <button onclick="fetchFormats()">ğŸ” Show Formats</button>
  <br><br>

  <select id="quality"></select>
  <button onclick="downloadVideo()">â¬‡ï¸ Download</button>
  <p id="status"></p>

  <hr>
  <h3>ğŸ•“ Download History (This Session Only)</h3>
  <ul id="historyList"></ul>

  <script>
    async function fetchFormats() {
      const url = document.getElementById("url").value;
      const res = await fetch('/formats', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url})
      });

      if (!res.ok) {
        document.getElementById("status").innerText = await res.text();
        return;
      }

      const formats = await res.json();
      const select = document.getElementById("quality");
      select.innerHTML = "";
      formats.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.format_id;
        opt.textContent = `${f.resolution} â€” ${Math.round((f.filesize || 0)/1024/1024)} MB`;
        select.appendChild(opt);
      });

      document.getElementById("status").innerText = `âœ… Formats loaded: ${formats.length}`;
    }

    async function downloadVideo() {
      const url = document.getElementById("url").value;
      const quality = document.getElementById("quality").value;

      const res = await fetch('/download', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url, quality})
      });

      if (res.ok) {
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "video.mp4";
        a.click();
        document.getElementById("status").innerText = "âœ… Download complete";
        loadHistory();
      } else {
        document.getElementById("status").innerText = await res.text();
      }
    }

    async function loadHistory() {
      const res = await fetch('/history');
      const list = await res.json();
      const ul = document.getElementById("historyList");
      ul.innerHTML = "";
      list.reverse().forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.title} â€” ${item.resolution} â€” ${item.size_MB} MB`;
        ul.appendChild(li);
      });
    }

    loadHistory();
  </script>
</body>
</html>
